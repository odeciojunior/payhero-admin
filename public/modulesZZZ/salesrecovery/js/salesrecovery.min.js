var exportFormat=null;$(document).ready((function(){loadingOnScreen(),$.ajax({method:"GET",url:"/api/projects?select=true",dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(t){console.log("entrei erro"),loadingOnScreenRemove(),errorAjaxResponse(t)},success:function(t){isEmpty(t.data)?($("#export-excel").hide(),$("#project-not-empty").hide(),$("#project-empty").show()):($("#project-empty").hide(),$("#project-not-empty").show(),$("#export-excel").show(),$.each(t.data,(function(t,e){$("#project").append($("<option>",{value:e.id,text:e.name}))})),e()),loadingOnScreenRemove()}}),$(".applySelect2").select2({width:"100%",multiple:!0,language:{noResults:function(){return"Nenhum resultado encontrado"},searching:function(){return"Procurando..."}}}),$("#bt_filtro").on("click",(function(t){t.preventDefault(),e()})),$("#bt_get_csv").on("click",(function(){$("#modal-export-sale").modal("show"),exportFormat="csv"})),$("#bt_get_xls").on("click",(function(){$("#modal-export-sale").modal("show"),exportFormat="xls"})),$(".btn-confirm-export-sale").on("click",(function(){var t,e,a=new RegExp(/^[A-Za-z0-9_\-\.]+@[A-Za-z0-9_\-\.]{2,}\.[A-Za-z0-9]{2,}(\.[A-Za-z0-9])?/),n=$("#email_export").val();if(""==n||!a.test(n))return alertCustom("error","Preencha o email corretamente"),!1;t=exportFormat,e=function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e={project:$("#project").val(),recovery_type:$("#recovery_type option:selected").val(),date_range:$("#date-range-sales-recovery").val(),client:$("#client-name").val(),client_document:$("#client-cpf").val(),plan:$("#plan").val(),date_type:"created_at"};if(Object.keys(e).forEach((function(t){Array.isArray(e[t])&&(e[t]=e[t].filter((function(t){return t})).join(","))})),t){var a="";for(var n in e)a+="&"+n+"="+e[n];return encodeURI(a)}return e}(),e.format=t,e.email=$("#email_export").val(),$.ajax({method:"POST",url:"/api/recovery/export",data:e,headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(t){errorAjaxResponse(t)},success:function(t){$("#export-email").text(t.email),$("#alert-export").show().shake()}}),$("#modal-export-sale").modal("hide")}));moment().subtract(30,"days").format("YYYY-MM-DD"),moment().format("YYYY-MM-DD");function t(t){var e="";e=null==t?"?project=".concat($("#project").val(),"&recovery_type=").concat($("#recovery_type option:selected").val(),"&date_range=").concat($("#date-range-sales-recovery").val(),"&client=").concat($("#client-name").val(),"&date_type=created_at&client_document=").concat($("#client-cpf").val(),"&plan=").concat($("#plan").val()):"".concat(t,"&project=").concat($("#project").val(),"\n\n            &recovery_type=").concat($("#recovery_type option:selected").val(),"\n            \n            &date_range=").concat($("#date-range-sales-recovery").val(),"\n            \n            &client=").concat($("#client-name").val(),"\n            \n            &date_type=created_at&client_document=").concat($("#client-cpf").val(),"\n            \n            &plan=").concat($("#plan").val());var a=$("#recovery_type option:selected").val();return 1==a?"/api/checkout".concat(e):3==a?"/api/recovery/getrefusedcart".concat(e):4==a?"/api/recovery/get-pix".concat(e):5==a?"/api/recovery/getboleto".concat(e):"/api/sales".concat(e)}function e(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;loadOnTable("#table_data","#carrinhoAbandonado"),o=t(o),$.ajax({method:"GET",url:o,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(t){errorAjaxResponse(t)},success:function(t){$("#table_data").html(""),$("#carrinhoAbandonado").addClass("table-striped");var o=$("#recovery_type").children("option:selected").text().toLowerCase(),s=$("#table_data").attr("img-empty");""==t.data&&o?($("#pagination-salesRecovery").hide(),$("#table_data").html("<tr>\n                            <td colspan='11' class='text-center' style='vertical-align: middle;height:257px;'>\n                                <img style='width:124px;margin-right:12px;' src=".concat(s,">\n                                Nenhum ").concat(o," encontrado\n                            </td>\n                        </tr>"))):(n(t),$("#pagination-salesRecovery").show(),pagination(t,"salesRecovery",e),$(".copy_link").on("click",(function(){var t=$("<input>");$("body").append(t),t.val($(this).attr("link")).select(),document.execCommand("copy"),t.remove(),alertCustom("success","Link copiado!")})),"5"==$("#recovery_type option:selected").val()&&(0==verifyAccountFrozen()&&$(".sale_status").hover((function(){$(this).css("cursor","pointer").text("Regerar"),$(this).css("background","#545B62")}),(function(){var t=$(this).attr("status");$(this).removeAttr("style"),$(this).text(t)})),$("#date").val(moment(new Date).add(3,"days").format("YYYY-MM-DD")),$("#date").attr("min",moment(new Date).format("YYYY-MM-DD")),$(".sale_status").on("click",(function(){if(0==verifyAccountFrozen()){$("#saleId").val("");var t=$(this).attr("sale_id");$("#saleId").val(t),$("#modal_regerar_boleto").modal("show"),$("#bt_send").unbind("click"),$("#bt_send").on("click",(function(){loadingOnScreen(),a(t)}))}}))),$(".details-cart-recovery").unbind("click"),$(".details-cart-recovery").on("click",(function(){c($(this).data("venda"))})),$(".estornar_venda").unbind("click"),$(".estornar_venda").on("click",(function(){id_venda=$(this).attr("venda"),$("#modal_estornar_titulo").html("Estornar venda #"+id_venda+" ?"),$("#modal_estornar_body").html("")})))}})}function a(t){$.ajax({method:"POST",url:"/api/recovery/regenerateboleto",dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},data:{saleId:t,date:$("#date").val(),discountType:$("#discount_type").val(),discountValue:$("#discount_value").val()},error:function(t){loadingOnScreenRemove(),errorAjaxResponse(t)},success:function(){loadingOnScreenRemove(),$(".loading").css("visibility","hidden"),window.location="/sales"}})}function n(t){var e="";$.each(t.data,(function(t,a){"cart_refundend"===a.type||"expired"===a.type?e+=o(a):void 0===a.sale_code?e+=function(t){var e="";return e+="<tr>",e+="<td class='display-sm-none display-m-none display-lg-none'>"+t.date+"</td>",e+="<td>"+t.project+"</td>",e+="<td class='display-sm-none display-m-none'>"+t.client+"</td>",e+="<td>"+t.email_status+" "+l(t.email_status)+"</td>",e+="<td>"+t.sms_status+" "+l(t.sms_status)+"</td>",e+="<td><span class='sale_status badge badge-"+s[t.status_translate]+"' status='"+t.status_translate+"' sale_id='"+t.id+"'>"+t.status_translate+"</span></td>",e+="<td>"+t.value+"</td>",e+="<td class='display-sm-none' align='center'> <a href='"+t.whatsapp_link+"' target='_blank' title='Enviar mensagem pelo whatsapp'><span class='o-whatsapp-1'></span></a></td>",e+="<td style='padding:0 !important;' class='display-sm-none text-center' align='center'> <a role='button' class='copy_link' style='cursor:pointer;' link='"+t.link+"' title='Copiar link'><span class='material-icons icon-copy-1'> content_copy </span></a></td>",e+="<td class='display-sm-none' align='center'> <a role='button' class='details-cart-recovery' style='cursor:pointer;' data-venda='"+t.id+"' ><span class='o-eye-1'></span></button></td>",e+="</tr>"}(a):e+=o(a)})),$("#table_data").append(e)}function o(t){var e="";return e+="<tr>",e+="<td class='display-sm-none display-m-none display-lg-none'>"+t.start_date+"</td>",e+="<td>"+t.project+"</td>",e+="<td class='display-sm-none display-m-none'>"+t.client+"</td>",e+="<td>"+t.email_status+" "+l(t.email_status)+"</td>",e+="<td>"+t.sms_status+" "+l(t.sms_status)+"</td>",e+="<td><span class='sale_status badge badge-"+s[t.recovery_status]+"' sale_id='"+t.id_default+"'>"+t.recovery_status+"</span></td>",e+="<td>"+t.total_paid+"</td>",e+="<td class='display-sm-none' align='center'> <a href='"+t.whatsapp_link+"' target='_blank' title='Enviar mensagem pelo whatsapp'><span class='o-whatsapp-1'></span></a></td>",e+="<td class='display-sm-none text-right' style='padding:0!important' align='center'> <a role='button' class='copy_link' style='cursor:pointer;' link='"+t.link+"' title='Copiar link'><span class='material-icons icon-copy-1'> content_copy </span></a></td>",e+="<td class='display-sm-none' align='center'> <a role='button' class='details-cart-recovery' style='cursor:pointer;' data-venda='"+t.id_default+"' ><span class='o-eye-1'></span></button></td>",e+="</tr>"}function c(t){$.ajax({method:"POST",url:"/api/recovery/details",data:{checkout:t},dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(t){errorAjaxResponse(t)},success:function(t){$("#table-product").html(""),isEmpty(t.data)||function(t){$("#status-checkout").removeClass("badge-success badge-danger"),$("#client-whatsapp").attr("href",""),$(".clear-fields").empty(),$("#modal-title").html("Detalhes <br><hr>"),$("#date-as-hours").html("".concat(t.checkout.date," às ").concat(t.checkout.hours)),$("#status-checkout").addClass("badge-"+s[t.status]).html(t.status);var e="";$.each(t.products,(function(t,a){isEmpty(a.photo)||a.photo,e+='<div class="row align-items-baseline justify-content-between mb-15"><div class="col-lg-2"><img onerror=this.src=\'/modules/global/img/produto.png\' src=\''+a.photo+"' width='50px' style='border-radius: 6px;'></div><div class=\"col-lg-5\"><h4 class=\"table-title\">"+a.name+'</h4>\n</div><div class="col-lg-3 text-right"><p class="sm-text text-muted">'+a.amount+"x</p></div></div>",$("#table-product").html(e)})),$("#total-value").html("R$ "+t.checkout.total),$("#client-name-details").html("Nome: "+t.client.name),$("#client-telephone").html("Telefone: "+t.client.telephone),$("#client-whatsapp").attr("href",t.client.whatsapp_link),$("#client-email").html("E-mail: "+t.client.email),$("#client-document").html("CPF: "+t.client.document),$("#client-street").html("Endereço: "+t.delivery.street),$("#client-zip-code").html("CEP: "+t.delivery.zip_code),$("#client-city-state").html("Cidade: "+t.delivery.city+"/"+t.delivery.state),$("#sale-motive").html("Motivo: "+t.client.error),"boletoCartao"==t.method&&""==t.delivery.street&&""==t.delivery.zip_code&&""==t.delivery.city&&""==t.delivery.state?$("#div_delivery").hide():$("#div_delivery").show();isEmpty(t.link)?$("#link-sale").html("Link: "+t.link):$("#link-sale").html('Link: <a role="button" class="copy_link" style="cursor:pointer;" link="'+t.link+'" title="Copiar link"><span class="o-copy-1"></span> </a> ');$("#checkout-ip").html("IP: "+t.checkout.ip),$("#checkout-is-mobile").html(t.checkout.is_mobile),$("#checkout-operational-system").html("Sistema: "+t.checkout.operational_system),$("#checkout-browser").html("Navegador: "+t.checkout.browser),$("#checkout-src").html("SRC: "+t.checkout.src),$("#checkout-utm-source").html("UTM Source: "+t.checkout.utm_source),$("#checkout-utm-medium").html("UTM Medium: "+t.checkout.utm_medium),$("#checkout-utm-campaign").html("UTM Campaign: "+t.checkout.utm_campaign),$("#checkout-utm-term").html("UTM Term: "+t.checkout.utm_term),$("#checkout-utm-content").html("UTM Content: "+t.checkout.utm_content),$("#modal_detalhes").modal("show"),$(".copy_link").on("click",(function(){var t=$("<input>");$("#nav-tabContent").append(t),t.val($(this).attr("link")).select(),document.execCommand("copy"),t.remove(),alertCustom("success","Link copiado!")}))}(t.data)}})}$("#date-range-sales-recovery").daterangepicker({startDate:moment().subtract(30,"days"),endDate:moment(),opens:"center",maxDate:moment().endOf("day"),alwaysShowCalendar:!0,showCustomRangeLabel:"Customizado",autoUpdateInput:!0,locale:{locale:"pt-br",format:"DD/MM/YYYY",applyLabel:"Aplicar",cancelLabel:"Limpar",fromLabel:"De",toLabel:"Até",customRangeLabel:"Customizado",weekLabel:"W",daysOfWeek:["Dom","Seg","Ter","Qua","Qui","Sex","Sab"],monthNames:["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],firstDay:0},ranges:{Hoje:[moment(),moment()],Ontem:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Últimos 7 dias":[moment().subtract(6,"days"),moment()],"Últimos 30 dias":[moment().subtract(29,"days"),moment()],"Este mês":[moment().startOf("month"),moment().endOf("month")],"Mês passado":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")],"Vitalício":[moment("2018-01-01 00:00:00"),moment()]}},(function(t,e){t.format("YYYY-MM-DD"),e.format("YYYY-MM-DD")})),$("#discount_value").mask("00%",{reverse:!0}),$("#apply_discount").on("click",(function(){$("#div_discount").is(":visible")?($("#div_discount").hide(),$("#discount_value").val("")):($("#div_discount").show(),$("#discount_type").on("change",(function(){"value"==$("#discount_type").val()?($("#discount_value").mask("#.###,#0",{reverse:!0}).removeAttr("maxlength"),$("#label_discount_value").html("Valor (ex: 20,00)")):($("#discount_value").mask("00%",{reverse:!0}),$("#label_discount_value").html("Valor (ex: 20%)"))})))}));var s={Recuperado:"success","Não recuperado":"danger",Recusado:"danger",Expirado:"danger"};function l(t){return 1===t?"enviado":t>1?"enviados":""}$(".applySelect2").on("select2:select",(function(t){var e=t.params.data,a=$(this).attr("id");!function(t,e){var a=$("#".concat(e)),n=a.val();if("all"!=t.id&&""!=t.id){if(n){var o=n.indexOf("all");o>=0&&(n.splice(o,1),a.val(n).change())}}else n&&(n.splice(0,n.lenght),a.val(null).change(),n.push("all"),a.val("all").change())}(e,a),$("#".concat(a)).focus().scrollTop(0),$(".select2-selection.select2-selection--multiple").scrollTop(0)})),$(".applySelect2").on("change",(function(){var t,e,a=$(this).attr("id");t=a,e=$("#".concat(t)).val(),0===$("#".concat(t)).val().length&&(e.push("all"),e=$("#".concat(t)).val("all").trigger("change"))})),$(document).on("focusout",".select2-selection__rendered",(function(){$(".select2-selection.select2-selection--multiple").scrollTop(0)})),$(document).on("focusin",".select2-selection__rendered",(function(){$(".select2-selection.select2-selection--multiple").scrollTop(0)})),$("#plan").select2({language:{noResults:function(){return"Nenhum plano encontrado"},searching:function(){return"Procurando..."}},ajax:{data:function(t){return{list:"plan",search:t.term,project_id:$("#project").val()}},method:"GET",url:"/api/sales/user-plans",delay:300,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},processResults:function(t){return result=$.map(t.data,(function(t){return{id:t.id,text:t.name+(t.description?" - "+t.description:"")}})),t.data.length>0&&result.splice(0,0,{id:"",text:"Todos os Planos"}),{results:result}}}}),$(".btn-light-1").click((function(){var t=$("#icon-filtro"),e=$("#text-filtro");e.fadeOut(10),"matrix(1, 0, 0, 1, 0, 0)"==t.css("transform")||"none"==t.css("transform")?(t.css("transform","rotate(180deg)"),e.text("Minimizar filtros").fadeIn()):(t.css("transform","rotate(0deg)"),e.text("Filtros avançados").fadeIn())})),$(document).on("keypress",(function(t){13==t.keyCode&&e()}))}));
