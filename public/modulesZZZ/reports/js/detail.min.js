$((function(){$("#discount_value").mask("00%",{reverse:!0}),$("#apply_discount").on("click",(function(){$("#div_discount").is(":visible")?($("#div_discount").hide(),$("#discount_value").val("")):($("#div_discount").show(),$("#discount_type").on("change",(function(){"value"==$("#discount_type").val()?($("#discount_value").mask("#.###,#0",{reverse:!0}).removeAttr("maxlength"),$("#label_discount_value").html("Valor (ex: 20,00)")):($("#discount_value").mask("00%",{reverse:!0}),$("#label_discount_value").html("Valor (ex: 20%)"))})))})),$(document).on("click","#boleto-link .copy_link",(function(){var e=$("<input>");$("#nav-tabContent").append(e),e.val($(this).attr("link")).select(),document.execCommand("copy"),e.remove(),alertCustom("success","Link copiado!")})),$(document).on("click","#boleto-digitable-line .copy_link",(function(){var e=$("<input>");$("#nav-tabContent").append(e),e.val($(this).attr("digitable-line")).select(),document.execCommand("copy"),e.remove(),alertCustom("success","Linha Digitável copiado!")})),$(document).on("click",".btn-copy-thank-page-url",(function(){var e=$("<input>");$("#nav-tabContent").append(e),e.val($(this).attr("link")).select(),document.execCommand("copy"),e.remove(),alertCustom("success","Link copiado!")})),$(".btn-edit-client").on("click",(function(){var e=$(this).parent();e.find("input").removeClass("fake-label").prop("readonly",!1),$(this).hide(),e.find(".btn-save-client").show(),e.find(".btn-close-client").show()})),$(".btn-close-client").on("click",(function(){var e=$(this).parent();e.find("input").addClass("fake-label").prop("readonly",!0),$(this).hide(),e.find(".btn-save-client").hide(),e.find(".btn-edit-client").show()})),$(".btn-save-client").on("click",(function(){var e=this,t=$(this).parent(),a=t.find("input"),n={id:a.attr("client"),name:a.attr("name"),value:a.val(),_method:"PUT"};$.ajax({method:"POST",url:"/api/customers/update",dataType:"json",data:n,headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){errorAjaxResponse(e)},success:function(n){a.addClass("fake-label").prop("readonly",!0),$(e).hide(),t.find(".btn-close-client").hide(),t.find(".btn-edit-client").show(),alertCustom("success","Dados do cliente alterados com successo!")}})})),$(document).on("click",".btn-edit-observation",(function(){var e=$(this).parent();e.find("input").removeClass("fake-label").prop("readonly",!1),$(this).hide(),e.find(".btn-save-observation").show(),e.find(".btn-close-observation").show()})),$(document).on("click",".btn-close-observation",(function(){var e=$(this).parent();e.find("input").addClass("fake-label").prop("readonly",!0),$(this).hide(),e.find(".btn-save-observation").hide(),e.find(".btn-edit-observation").show()})),$(document).on("click",".btn-save-observation",(function(){var e=this;if(""==$("#refund-observation").val())return alertCustom("error","Dados informados inválidos"),!1;var t=$(this).parent(),a=t.find("input"),n={id:a.attr("sale"),name:a.attr("name"),value:a.val()};$.ajax({method:"POST",url:"/api/sales/updaterefundobservation/"+a.attr("sale"),dataType:"json",data:n,headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){errorAjaxResponse(e)},success:function(n){a.addClass("fake-label").prop("readonly",!0),$(e).hide(),t.find(".btn-close-observation").hide(),t.find(".btn-edit-observation").show(),alertCustom("success","Causa do estorno alterado com successo!")}})})),$(document).on("click",".detalhes_venda",(function(){var e=$(this).attr("venda");loadOnAny("#modal-saleDetails"),$("#modal_detalhes").modal("show"),$("#refundAmount").mask("##.###,#0",{reverse:!0}),$("#refundBilletAmount").mask("##.###,#0",{reverse:!0}),$.ajax({method:"GET",url:"/api/sales/"+e,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){errorAjaxResponse(e)},success:function(e){!function(e){(function(e){$("#sale-code").text(e.id),!e.upsell||$("#sale-code").append('<span class="text-muted font-size-16 d-block mt-1"> Upsell → '.concat(e.upsell,"</span>"));$("#payment-type").text("Pagamento via "+(2===e.payment_method?"Boleto":"Cartão "+e.flag)+" em "+e.start_date+" às "+e.hours),""!=e.release_date?$("#release-date").text("Data de liberação: "+e.release_date):$("#release-date").text("");var t=$(".modal-body #status");switch(t.html(""),t.append('<img style="width: 50px;" src="/modules/global/img/cartoes/'+e.flag+'.png">'),e.status){case 1:t.append("<span class='ml-2 badge badge-success'>Aprovada</span>");break;case 2:t.append("<span class='ml-2 badge badge-pendente'>Pendente</span>");break;case 3:t.append("<span class='ml-2 badge badge-danger'>Recusada</span>");break;case 4:t.append("<span class='ml-2 badge badge-danger'>Chargeback</span>");break;case 6:t.append("<span class='ml-2 badge badge-primary'>Em análise</span>");break;case 7:case 22:t.append("<span class='ml-2 badge badge-danger'>Estornado</span>");break;case 8:t.append("<span class='ml-2 badge badge-danger'>Estorno Parcial</span>");break;case 20:t.append("<span class='ml-2 badge badge-antifraude'>Revisão Antifraude</span>");break;case 23:t.append("<span class='ml-2 badge badge-warning'>Recuperado</span>");break;case 24:t.append("<span class='ml-2 badge badge-antifraude'>Em disputa</span>");break;default:t.append("<span class='ml-2 badge badge-primary'>"+e.status+"</span>")}e.is_chargeback_recovered&&1==e.status?$("#chargeback-recovered").show():$("#chargeback-recovered").hide();$("#subtotal-value").html("R$ "+e.subTotal),$("#shipment-value").html("R$ "+e.shipment_value),$("#iof-label, #iof-value, #cambio-label, #cambio-value").hide(),e.dolar_quotation&&($("#cambio-label span").text("Câmbio (1 $ = R$ "+e.dolar_quotation+"): "),$("#cambio-value span").text("US$ "+e.taxa),$("#cambio-label, #cambio-value").show());$("#taxas-installment-free-label, #taxa-installment-value").hide(),"0,00"!==e.installment_tax_value&&"producer"==e.user_sale_type&&($("#taxa-installment-value").html("R$ "+e.installment_tax_value),$("#taxas-installment-free-label").show(),$("#taxa-installment-value").show());$("#desconto-value").html("R$ "+e.discount),$(".text-discount").html(""),$("#automatic-discount-value").html(""),"0,00"!==e.automatic_discount&&(2==e.payment_method?$(".text-discount").html("Desconto automático boleto"):$(".text-discount").html("Desconto automático cartão"),$("#automatic-discount-value").html("R$ "+e.automatic_discount));$("#total-value").html("R$ "+e.total),"0,00"!=e.refund_value&&8==e.status?($(".text-partial-refund").show(),$("#partial-refund-value").html("R$ "+e.refund_value),$("#partial-refund-value").show()):($(".text-partial-refund").hide(),$("#partial-refund-value").hide());$("#taxas-label").text(e.tax?"Taxas ("+e.tax+"% + "+e.transaction_tax+"): ":"Taxas"),$("#taxareal-value").text(e.taxaReal?e.taxaReal:""),$("#convertax-label, #convertax-value").hide(),"0,00"!==e.convertax_value&&($("#convertax-value").text(e.convertax_value?e.convertax_value:""),$("#convertax-label, #convertax-value").show());"0,00"!=e.value_anticipable&&($(".div-anticipated").show(),$(".div-value-anticipated").html("").append("<span id=\"taxareal-value\" class='text-muted ft-12'>R$ ".concat(e.value_anticipable,"</span>")).show());"affiliate"==e.user_sale_type?($(".div-main-comission-value").html("<h4 id='comission-value' class='table-title'></h4>"),$(".div-main-comission").html("<h4 class='table-title'>Comissão: </h4>"),null!=e.affiliate?($(".div-user-type-comission-value").show().html("<span id='user-type-comission-value' class='text-muted ft-12'></span>"),$(".div-user-type-comission").show().html("<span class='text-muted ft-12'>Comissão do produtor: </span>"),$("#user-type-comission-value").html(e.comission)):($(".div-user-type-comission-value").hide(),$(".div-user-type-comission").hide())):($(".div-main-comission-value").html("<h4 id='comission-value' class='table-title'></h4>"),$(".div-main-comission").html("<h4 class='table-title'>Comissão: </h4>"),null!=e.affiliate?($(".div-sale-by-affiliate").show().html("<h4 class='table-title'>Venda realizada pelo afiliado "+e.affiliate+"</h4>"),$(".div-user-type-comission-value").show().html("<span id='user-type-comission-value' class='text-muted ft-12'></span>"),$(".div-user-type-comission").show().html("<span class='text-muted ft-12'>Comissão do afiliado: </span>"),$("#user-type-comission-value").html(e.affiliate_comission)):($(".div-sale-by-affiliate").hide(),$(".div-affiliate-name").hide().html(""),$(".div-user-type-comission-value").hide(),$(".div-user-type-comission").hide()),$("#comission-value").text(e.comission?e.comission:""));""!=e.affiliate_comission&&"affiliate"==e.user_sale_type&&$("#comission-value").text(e.affiliate_comission);e.has_shopify_integration?(e.shopify_order||20==e.status?($("#resendShopfyOrder").addClass("d-none"),$("#resendShopfyOrder").removeClass("d-block"),$("#resendeShopifyOrderButton").attr("sale","")):($("#resendShopfyOrder").removeClass("d-none"),$("#resendShopfyOrder").addClass("d-block"),$("#resendeShopifyOrderButton").attr("sale",e.id),$(".btn_new_order_shopify").unbind("click"),$(".btn_new_order_shopify").on("click",(function(){var e=$(this).attr("sale");$("#modal-new-order-shopify").modal("show"),$("#modal_detalhes").modal("hide"),$(".btn-confirm-new-order-shopify").unbind("click"),$(".btn-confirm-new-order-shopify").on("click",(function(){!function(e){loadingOnScreen(),$.ajax({method:"POST",url:"/api/sales/newordershopify/"+e,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){loadingOnScreenRemove(),errorAjaxResponse(e),atualizar(currentPage)},success:function(e){loadingOnScreenRemove(),alertCustom("success",e.message),atualizar(currentPage)}})}(e)}))}))),$("#details-shopify").show()):($("#resendShopfyOrder").addClass("d-none"),$("#resendShopfyOrder").removeClass("d-block"),$("#resendeShopifyOrderButton").attr("sale",""));1===e.payment_method&&($("#details-card #card-flag").text("Bandeira: "+e.flag),$("#details-card #card-installments").text("Quantidade de parcelas: "+e.installments_amount),$("#details-card").show(),$("#details-boleto").hide());2===e.payment_method&&($("#details-boleto #boleto-link a").attr("link",e.boleto_link),$("#details-boleto #boleto-digitable-line a").attr("digitable-line",e.boleto_digitable_line),$("#details-boleto #boleto-due").text("Vencimento: "+e.boleto_due_date),$("#details-card").hide(),$("#details-boleto").show());$("#checkout-attempts").hide(),1===e.payment_method&&$("#checkout-attempts").text("Quantidade de tentativas: "+e.attempts).show();1!=e.payment_method&&3!=e.payment_method||1!=e.status&&8!=e.status&&24!=e.status||!e.userPermissionRefunded?$("#div_refund_transaction").html(""):$("#div_refund_transaction").html('<button class="btn btn-danger btn-sm btn_refund_transaction" sale='+e.id+">Estornar transação</button>");7==e.status&&$("#div_refund_receipt").html('<a class="btn btn-sm btn-primary" target="_blank" href="/sales/'.concat(e.id,'/refundreceipt">Comprovante de estorno</a>'));2==e.status||1==e.status?$("#saleReSendEmail").show():$("#saleReSendEmail").hide();2==e.payment_method&&1==e.status&&e.userPermissionRefunded?$("#div_refund_billet").html('<button class="btn btn-secondary btn-sm btn_refund_billet float-right" sale='+e.id+">Estornar boleto</button>"):$("#div_refund_billet").html("");null!=e.refund_observation?($(".div-refund-observation").show(),$("#refund-observation").val(e.refund_observation).attr("sale",e.id),e.user_changed_observation?$(".btn-edit-observation").show():$(".btn-edit-observation").hide()):$(".div-refund-observation").hide();""!=e.thank_page_url?($("#thank-page-url").text("Link página de obrigado:").show(),$(".btn-copy-thank-page-url").attr("link",e.thank_page_url),$(".btn-copy-thank-page-url").show()):($("#thank-page-url").hide(),$(".btn-copy-thank-page-url").hide());""!=e.delivery_id?$("#div_delivery").css("display","block"):$("#div_delivery").css("display","none")})(e),t=e.client_id,void $.ajax({method:"GET",url:"/api/customers/"+t,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){errorAjaxResponse(e)},success:function(e){!function(e){$("#client-name").text("Nome: "+e.name),$("#client-telephone").val(e.telephone).attr("client",e.code).mask("+0#"),$("#client-email").val(e.email).attr("client",e.code),$("#client-document").text("CPF: "+e.document),$("#client-whatsapp").attr("href",e.whatsapp_link)}(e.data)}}),function(e){$.ajax({method:"GET",url:"/api/products/saleproducts/"+e.id,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){errorAjaxResponse(e)},success:function(t){!function(e,t){$("#table-product").html(""),$("#data-tracking-products").html("");var a="",n="/modules/global/img/produto.png";$.each(e,(function(e,o){if(o.photo||(o.photo=n),a+='<div class="row align-items-baseline justify-content-between mb-15">\n                        <div class="col-lg-2">\n                            <img src=\''.concat(o.photo,"' onerror=this.src='/modules/global/img/produto.png' width='50px' style='border-radius: 6px;'>\n                        </div>\n                        <div class=\"col-lg-5\">\n                            <h4 class=\"table-title mb-0\">").concat(o.name,"</h4>\n                            <small>").concat(o.description,'</small>\n                        </div>\n                        <div class="col-lg-3 text-right">\n                            <p class="sm-text text-muted">').concat(o.amount,"x</p>\n                        </div>\n                    </div>"),$("#table-product").html(a),1!=o.sale_status&&4!=o.sale_status||""==t.delivery_id)$("#div_tracking_code").css("display","none");else{var s="<tr>\n                                <td>\n                                    <img onerror=\"this.src='/modules/global/img/produto.png'\" src='".concat(o.photo,"'  width='35px;' style='border-radius:6px;'><br>\n                                    <span class='small ellipsis'>").concat(o.name,'</span>\n                                </td>\n                                <td>\n                                    <span class="small font-weight-bold">').concat(o.tracking_code,"</span>\n                                </td>\n                                <td>\n                                    <span class='tracking-status-span small'>").concat(o.tracking_status_enum,"</span>\n                                </td>\n                                <td>\n                                    <span class='small'>").concat(o.tracking_created_at,"</span>\n                                </td>\n                            </tr>");$("#div_tracking_code").css("display","block"),$("#data-tracking-products").append(s)}}))}(t.data,e)}})}(e),""!=e.delivery_id&&(a=e.delivery_id,$.ajax({method:"GET",url:"/api/delivery/"+a,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){errorAjaxResponse(e)},success:function(e){!function(e){$(".btn-save-trackingcode").attr("delivery",e.id);var t="Endereço: "+e.street+", "+e.number;isEmpty(e.complement)||(t+=", "+e.complement),$("#delivery-address").text(t),$("#delivery-neighborhood").text("Bairro: "+e.neighborhood),$("#delivery-zipcode").text("CEP: "+e.zip_code),$("#delivery-city").text("Cidade: "+e.city+"/"+e.state)}(e.data)}}));var t;var a;n=e.checkout_id,$.ajax({method:"GET",url:"/api/checkout/"+n,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){errorAjaxResponse(e)},success:function(e){var t;t=e.data,$("#checkout-ip").text("IP: "+t.ip),$("#checkout-operational-system").text("Dispositivo: "+t.operational_system),$("#checkout-browser").text("Navegador: "+t.browser),$("#checkout-src").text("SRC: "+t.src),$("#checkout-source").text("UTM Source: "+t.source),$("#checkout-medium").text("UTM Medium: "+t.utm_medium),$("#checkout-campaign").text("UTM Campaign: "+t.utm_campaign),$("#checkout-term").text("UTM Term: "+t.utm_term),$("#checkout-content").text("UTM Content: "+t.utm_content),loadOnAny("#modal-saleDetails",!0)}}),function(e){if(!isEmpty(e)){var t=e[e.length-1];$.ajax({method:"GET",url:"/api/apps/notazz/invoice/"+t,dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){errorAjaxResponse(e)},success:function(e){!function(e){if(isEmpty(e))$("#div_notazz_invoice").hide();else{if($("#data-notazz-invoices").empty(),e.date_pending){var t="<tr>\n                                <td>\n                                    ".concat(e.date_pending,"\n                                </td>\n                                <td>\n                                    Pendente de envio\n                                </td>\n                                <td>\n                                    0\n                                </td>\n                                <td>\n                                    Sucesso\n                                </td>\n                                <td>\n\n                                </td>\n                            </tr>");$("#data-notazz-invoices").append(t)}if(e.date_sent){var a=null==e.return_message?"Sucesso":e.return_message,n=e.return_message?"Erro ao enviar para Notazz":"Enviado para Notazz",o=e.pdf?"<a href='"+e.pdf+"' class='copy_link' style='cursor:pointer;' target='_blank'><span class='material-icons icon-copy-1'> content_copy </span></a>":"",s="<tr>\n                                <td>\n                                    ".concat(e.date_sent,"\n                                </td>\n                                <td>\n                                    ").concat(n,"\n                                </td>\n                                <td>\n                                    ").concat(e.return_http_code,"\n                                </td>\n                                <td>\n                                    ").concat(a,"\n                                </td>\n                                <td>\n                                    ").concat(o,"\n                                </td>\n                            </tr>");$("#data-notazz-invoices").append(s)}if(e.date_error){var i=e.return_message?"Erro ao enviar para Notazz":"Enviado para Notazz",d="<tr>\n                                <td>\n                                    ".concat(e.date_error,"\n                                </td>\n                                <td>\n                                    ").concat(i,"\n                                </td>\n                                <td>\n                                    ").concat(e.return_http_code,"\n                                </td>\n                                <td>\n                                    ").concat(e.return_message,"\n                                </td>\n                                <td>\n\n                                </td>\n                            </tr>");$("#data-notazz-invoices").append(d)}if(e.date_rejected){var l=null==e.postback_message?"Rejeitado":e.postback_message,c="<tr>\n                                <td>\n                                    ".concat(e.date_sent,"\n                                </td>\n                                <td>\n                                    Nota fiscal rejeitada\n                                </td>\n                                <td>\n                                    ").concat(e.return_http_code,"\n                                </td>\n                                <td>\n                                    ").concat(l,"\n                                </td>\n                                <td>\n\n                                </td>\n                            </tr>");$("#data-notazz-invoices").append(c)}if(e.date_canceled){var r=e.pdf?"<a href='"+e.pdf+"' class='copy_link' style='cursor:pointer;' target='_blank'><span class='material-icons icon-copy-1'> content_copy </span></a>":"",u="<tr>\n                                <td>\n                                    ".concat(e.date_sent,"\n                                </td>\n                                <td>\n                                    Nota fical cancelada\n                                </td>\n                                <td>\n                                    ").concat(e.return_http_code,"\n                                </td>\n                                <td>\n                                    Sucesso\n                                </td>\n                                <td>\n                                    ").concat(r,"\n                                </td>\n                            </tr>");$("#data-notazz-invoices").append(u)}e.return_message&&$("#div_notazz_schedule").html("Próxima tentativa de envio em "+e.schedule),$("#div_notazz_invoice").show()}}(e.data)}})}}(e.invoices);var n}(e.data),$("#refundAmount").val(e.data.total),$("#refundBilletAmount").text("R$"+e.data.total),$(".btn_refund_transaction").unbind("click"),$(".btn_refund_transaction").on("click",(function(){var e=$(this).attr("sale");$("#modal-refund-transaction").modal("show"),$("#modal_detalhes").modal("hide"),$("#radioTotalRefund").on("click",(function(){$(".value-partial-refund").hide()})),$("#radioPartialRefund").on("click",(function(){$(".value-partial-refund").show()})),$(".btn-confirm-refund-transaction").unbind("click"),$(".btn-confirm-refund-transaction").on("click",(function(){var t=0;if(document.getElementById("radioPartialRefund").checked)t=1;var a=$("#refundAmount").val();!function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3?arguments[3]:void 0;loadingOnScreen(),$.ajax({method:"POST",url:"/api/sales/refund/"+e,data:{refunded_value:t,partial:a,refund_observation:n},dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){loadingOnScreenRemove(),errorAjaxResponse(e),atualizar(currentPage)},success:function(e){loadingOnScreenRemove(),alertCustom("success",e.message),$("#refund_observation").val(""),atualizar(currentPage)}})}(e,a,t,$("#refund_observation").val())}))})),$(".btn_refund_billet").unbind("click"),$(".btn_refund_billet").on("click",(function(){var t=$(this).attr("sale"),a=e.data.total;$(".billet-refunded-tax-value").text(e.data.taxaReal?e.data.taxaReal:""),$("#modal-refund-billet").modal("show"),$("#modal_detalhes").modal("hide"),$(".btn-confirm-refund-billet").unbind("click"),$(".btn-confirm-refund-billet").on("click",(function(){!function(e,t){loadingOnScreen(),$.ajax({method:"POST",url:"/api/sales/refund/billet/"+e,data:{refunded_value:t},dataType:"json",headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){loadingOnScreenRemove(),errorAjaxResponse(e),atualizar(currentPage)},success:function(e){loadingOnScreenRemove(),alertCustom("success",e.message),atualizar(currentPage)}})}(t,a)}))}))}})})),$(document).on("click","#btnSaleReSendEmail",(function(){var e,t;e=$("#sale-code").text(),(t=$("#btnSaleReSendEmail")).hasClass("sending")||(t.css("opacity",".5").addClass("sending"),$.ajax({method:"POST",url:"/api/sales/saleresendemail",dataType:"json",data:{sale:e},headers:{Authorization:$('meta[name="access-token"]').attr("content"),Accept:"application/json"},error:function(e){t.css("opacity","1").removeClass("sending"),errorAjaxResponse(e)},success:function(e){t.css("opacity","1").removeClass("sending"),alertCustom("success",e.message)}}))}))}));
