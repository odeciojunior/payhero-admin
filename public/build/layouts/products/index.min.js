$(document).ready(function () {
  var regexp = /http(s?):\/\/[\w.-]+\/products\/\w{15}\/edit/;
  var lastPage = document.referrer;

  if (!lastPage.match(regexp)) {
    localStorage.clear();
  }

  var pageCurrent;
  var badgeList = {
    1: "#2E85EC",
    2: "#5EE2A1",
    3: "#F41C1C"
  };
  var statusList = {
    1: "Em an√°lise",
    2: "Aprovado",
    3: "Recusado"
  }; //VERIFICA SE HA FILTRO E PEGA O TIPO

  var storeTypeProduct = function storeTypeProduct() {
    if (localStorage.getItem("filtersApplied")) {
      var getProductValue = JSON.parse(localStorage.getItem("filtersApplied"));
      return getProductValue;
    } else {
      return 0;
    }
  }; //REGASTA O FILTRO E O APLICA


  function handleLocalStorage() {
    if (localStorage.getItem('filtersApplied') != null) {
      var parseLocalStorage = JSON.parse(localStorage.getItem('filtersApplied'));
      $("#type-products").val(parseLocalStorage.getTypeProducts).trigger("change");
      $("#select-projects").val(parseLocalStorage.getProject);
      $("#name").val(parseLocalStorage.getName);
      $("#btn-filtro").trigger("click");
    }
  }

  function getProjects() {
    loadingOnScreen();
    $.ajax({
      method: "GET",
      url: "api/projects?select=true",
      dataType: "json",
      headers: {
        Authorization: $('meta[name="access-token"]').attr("content"),
        Accept: "application/json"
      },
      error: function error(response) {
        loadingOnScreenRemove();
        errorAjaxResponse(response);
      },
      success: function success(response) {
        if (!isEmpty(response.data)) {
          $("#project-empty").hide();
          $("#project-not-empty").show();

          if (verifyAccountFrozen()) {
            $("#div-create").hide();
          } else {
            $("#div-create").show();
          } //talvez verificar se ha filtro aqui


          updateProducts();
        } else {
          $("#project-empty").show();
          $("#project-not-empty").hide();
          $("#div-create").hide();
        }

        loadingOnScreenRemove();
      }
    });
  }

  function getTypeProducts() {
    $.ajax({
      method: "GET",
      url: "/api/projects?select=true",
      data: {
        status: "active"
      },
      dataType: "json",
      headers: {
        Authorization: $('meta[name="access-token"]').attr("content"),
        Accept: "application/json"
      },
      error: function error(response) {
        errorAjaxResponse(response);
      },
      success: function success(response) {
        if (response.data) {
          var has_shopify = false;
          $("#select-projects").html("");
          $.each(response.data, function (index, value) {
            if (value.shopify) {
              has_shopify = true;
              $("#select-projects").append($("<option>", {
                value: value.id,
                text: value.name
              }));
            }
          });

          if (has_shopify) {
            $("#select-projects").addClass('has_shopify');
          }
        }

        handleLocalStorage();
      }
    });
  }

  function updateProducts() {
    var link = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;
    pageCurrent = link; //RETONA O FILTRO SE HOUVER SENAO RETORNA NULL

    var existFilters = function existFilters() {
      if (localStorage.getItem('filtersApplied') != null) {
        var getFilters = JSON.parse(localStorage.getItem('filtersApplied'));
        return getFilters;
      } else {
        return null;
      }

      ;
    }; //GUARDA QUALQUER PAGINA DEPOIS DA 1


    if (link != null) {
      var getPage = {
        atualPage: pageCurrent
      };
      localStorage.setItem("page", JSON.stringify(getPage));
    } //RESGATA PAGINA, SE HOUVER FILTRO SET PAGINA PARA NULL


    if (localStorage.getItem("page") != null) {
      var parsePage = JSON.parse(localStorage.getItem("page"));

      if (existFilters() != null && existFilters().getName != "") {
        if (localStorage.getItem("page") != null) {
          localStorage.setItem("page", JSON.stringify(parsePage));
        }
      } else {
        pageCurrent = parsePage.atualPage;
      }

      parsePage = JSON.parse(localStorage.getItem("page"));
      pageCurrent = parsePage.atualPage;
    }

    link = pageCurrent;
    loadOnAny(".page-content");
    var type = existFilters() != null ? existFilters().getTypeProducts : $("#type-products").val();
    var name = existFilters() != null ? existFilters().getName : $("#name").val();
    var project = existFilters() != null ? existFilters().getProject : $("#select-projects").val();

    if (link == null) {
      link = "/api/products?shopify=" + type + "&project=" + project + "&name=" + name;
    } else {
      link = "/api/products" + link + "&shopify=" + type + "&project=" + project + "&name=" + name;
    }

    $.ajax({
      method: "GET",
      url: link,
      dataType: "json",
      headers: {
        Authorization: $('meta[name="access-token"]').attr("content"),
        Accept: "application/json"
      },
      error: function error(response) {
        loadOnAny(".page-content", true);
        errorAjaxResponse(response);
      },
      success: function success(response) {
        if (!isEmpty(response.data)) {
          var closeTooltips = function closeTooltips() {
            var except = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : "";
            $('.menu_product_tooltip[style*="display: block"]').each(function (_, tooltip) {
              if (except[0] == tooltip) {
                return;
              }

              tooltip.style.display = 'none';
            });
          };

          $(".products-is-empty").hide();
          $("#data-table-products").html("");
          var dados = "";
          $.each(response.data, function (index, value) {
            shopifyProduct = value.id != value.id_view;
            dados = "\n                        <div class=\"col-12 col-sm-6 col-md-4 col-lg-3 d-flex\">\n                            <div class=\"card shadow mb-20 mx-0\" style=\"flex: 1 1 100%\">\n                                <div style=\"margin: 10px 10px 0px 0px;position: absolute;right: 0px;\">\n                                    <button type=\"button\" class=\"menu_product\" data-id=\"".concat(value.id, "\">&#8942;</button>\n                                </div>\n                                <img class=\"card-img-top product-image pointer\" src=\"").concat(value.image, "\" alt=\"Imagem do produto\" data-link=\"/products/").concat(value.id, "/edit\">\n                                ").concat(value.type_enum == 2 ? "<span class=\"ribbon-inner ribbon-primary\" style=\"background-color:".concat(badgeList[value.status_enum], ";border-radius: 0px 10px 10px 0px;\"> ").concat(statusList[value.status_enum], "\n                                        </span>") : "", "\n                                <hr class=\"mt-0\">\n                                <div class=\"card-body py-0\">\n                                    <h5 class=\"card-title\">").concat(value.name, "</h5>\n                                    <h5 class=\"card-description\">").concat(value.description, "</h5>\n                                </div>\n                                <div class=\"card-footer bg-transparent\">\n                                    <p class=\"text-muted card-text sm\">Criado em ").concat(value.created_at, "</p>\n                                </div>\n                            </div>\n                            <div class=\"menu_product_tooltip\" data-id=\"").concat(value.id, "\">\n                                <a id=\"bt_editar\" href=\"/products/").concat(value.id, "/edit\" class=\"mx-20\"><span class=\"o-edit-1 mr-10\" />Editar produto</a>\n                                ").concat(shopifyProduct == false ? "\n                                    <hr class=\"my-5\">\n                                    <a href=\"#\" class=\"mx-20 bt_excluir\" data-id=\"".concat(value.id, "\"><span class=\"o-bin-1 mr-10\" />Excluir produto</a>\n                                ") : "", "\n                            </div>\n                        </div>\n                        ");
            $("#data-table-products").append(dados);
          });
          $(".product-image").off("click");
          $(".product-image").on("click", function () {
            window.location.href = $(this).attr('data-link');
          });
          $('.menu_product').off('click');
          $('.menu_product').on('click', function () {
            var tooltip = $(".menu_product_tooltip[data-id=\"".concat(this.dataset.id, "\"]"));
            closeTooltips(tooltip);
            tooltip.toggle();
          });
          $('.menu_product').off('focusout');
          $('.menu_product').on('focusout', function (event) {
            if ($(event.relatedTarget).hasClass('menu_product')) {
              return;
            }

            setTimeout(function () {
              return closeTooltips();
            }, 200);
          });
          $('.bt_excluir').off('click');
          $('.bt_excluir').on('click', function (event) {
            event.preventDefault();
            $(".bt_excluir_modal").attr('data-id', this.dataset.id);
            $("#modal-delete").modal();
          });
          $('.bt_excluir_modal').off('click');
          $('.bt_excluir_modal').on('click', function (event) {
            event.preventDefault();
            loadingOnScreen();
            $.ajax({
              method: 'DELETE',
              url: '/api/products/' + this.dataset.id,
              dataType: "json",
              headers: {
                'Authorization': $('meta[name="access-token"]').attr('content'),
                'Accept': 'application/json'
              },
              error: function error(response) {
                errorAjaxResponse(response);
                $(".bt_excluir_modal").attr('data-id', "");
                loadingOnScreenRemove();
              },
              success: function success(response) {
                alertCustom('success', response.message);
                window.location = "/products";
              }
            });
          });
          $("img").on("error", function () {
            $(this).attr("src", "https://cloudfox-files.s3.amazonaws.com/produto.svg");
          });
          pagination(response, "products", updateProducts);
          $(".products-is-empty").hide();
        } else {
          if (localStorage.getItem('filtersApplied') != null && localStorage.getItem('page') != null) {
            localStorage.removeItem('page');
            $("#btn-filtro").trigger("click");
          } else {
            $("#data-table-products, #pagination-products").html("");
            $(".products-is-empty").show();
          }
        }

        setTimeout(function () {
          loadOnAny(".page-content", true);
        }, 2000);
      }
    });
  } //PRECIONAR ENTER ATIVA O "APLICAR FILTRO"


  $(document).on("keypress", function (e) {
    if (e.key == "Enter") {
      $("#btn-filtro").trigger("click");
    }
  }); //EXIBI OU ESCONDE O CAMPO PROJETO

  $("#type-products").on("change", function () {
    var type = $(this).val();
    var $selectProject = $('#select-projects');
    console.log($selectProject.hasClass('has_shopify'));

    if (type === "1" && $selectProject.hasClass('has_shopify')) {
      $('#projects-list').removeClass('d-none');
      $("#projects-list select").prop("disabled", false).removeClass("disabled");
      $("#opcao-vazia").remove();
    } else {
      console.log('entrei');
      $("#projects-list select").prop("disabled", true).addClass("disabled");
      $("#projects-list").addClass("d-none");
    }
  }); //SE ALGUM CAMPO FOR ALTERADO ZERA A PAGINA E GUARDA O NOVO FILTRO

  $("#btn-filtro").on("click", function () {
    if (storeTypeProduct().getTypeProducts != $("#type-products").val() || storeTypeProduct().getName != $('#name').val() || storeTypeProduct().getProject != $('#select-projects').val()) {
      if (localStorage.getItem("page") != null) {
        var getPageStored = JSON.parse(localStorage.getItem("page"));
        getPageStored.atualPage = null;
        localStorage.setItem("page", JSON.stringify(getPageStored));
      }
    } //GUARDA O NOVO FILTRO


    var filtersApplied = {
      getTypeProducts: $("#type-products option:selected").val(),
      getProject: $("#select-projects option:selected").val(),
      getName: $("#name").val()
    };
    localStorage.setItem('filtersApplied', JSON.stringify(filtersApplied));
    updateProducts();
  });
  $('#new-product-button').on('click', function (event) {
    event.preventDefault();
    $('#new-product-modal').show();
  });
  getProjects();
  getTypeProducts(); //updateProducts(); //Funcao de update chamda pela 2x
});
