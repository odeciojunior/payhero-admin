$("#bt-withdrawal, #bt-withdrawal_m").on("click", function () {
  var availableBalanceText = $(".available-balance").html().replace(/,/g, "").replace(/\./g, "");
  var toTransferText = $("#custom-input-addon").val().replace(/,/g, "").replace(/\./g, "");
  var availableBalance = parseInt(availableBalanceText);
  var toTransfer = parseFloat(toTransferText);

  if (!verifyWithdrawalIsValid(toTransfer, availableBalance)) {
    return;
  }

  $("#bt-withdrawal, #bt-withdrawal_m").attr("disabled", "disabled");
  $.ajax({
    url: "/api/withdrawals/getWithdrawalValues",
    type: "POST",
    dataType: "json",
    data: {
      company_id: $('.company-navbar').val(),
      gateway_id: window.gatewayCode,
      withdrawal_value: $("#custom-input-addon").val()
    },
    headers: {
      Authorization: $('meta[name="access-token"]').attr("content"),
      Accept: "application/json"
    },
    error: function error(response) {
      errorAjaxResponse(response);
    },
    success: function success(response) {
      manipulateModalWithdrawal(response.data);
    },
    complete: function complete() {
      $("#bt-withdrawal, #bt-withdrawal_m").removeAttr("disabled");
    }
  });
});

function verifyWithdrawalIsValid(toTransfer, availableBalance) {
  if (toTransfer < 1) {
    alertCustom("error", "Valor do saque inválido!");
    $("#custom-input-addon").val("");
    $(".withdrawal-value").maskMoney({
      thousands: ".",
      decimal: ",",
      allowZero: true
    });
    return false;
  }

  if (toTransfer > availableBalance) {
    alertCustom("error", "O valor requerido ultrapassa o limite disponivel");
    $("#custom-input-addon").val("");
    $(".withdrawal-value").maskMoney({
      thousands: ".",
      decimal: ",",
      allowZero: true
    });
    return false;
  }

  if ($("#custom-input-addon").val() == "") {
    alertCustom("error", "Valor do saque inválido!");
    return false;
  }

  if (toTransfer < 5000) {
    alertCustom("error", "Valor mínimo de saque  R$ 50,00");
    return;
  }

  return true;
}

function modalDebitPending(currentBalance, debitValue) {
  var $modal = $("#debit-pending-informations");
  var $footer = $("#modal-withdrawal-custom-footer");
  var $modalCustomBody = $("#modal-body-withdrawal-custom");
  var $modalCustomTitle = $("#modal-title-withdrawal-custom");
  $modalCustomBody.html("").addClass("d-none");
  $modalCustomTitle.text("Não é possivel realizar este saque").parent().addClass("debit-pending");
  var result = currentBalance - removeFormatNumbers(debitValue);
  $modal.removeClass("d-none").html("\n                <h3 class=\"text-center mt-10\" id=\"text-title-debit-pending\">\n                    Voc\xEA tem d\xE9bitos pendentes superiores ao <br> valor do seu saldo dispon\xEDvel.\n                </h3>\n                <p id=\"text-description-debit-pending\">\n                    Voc\xEA s\xF3 poder\xE1 solicitar um saque quando seu saldo dispon\xEDvel for maior <br>\n                    que o valor dos d\xE9bitos pendentes.\n                </p>\n\n                <div id=\"debit-items\">\n                    <div class=\"row mx-0\">\n                        <div class='col-7'><p> VALOR SOLICITADO </p></div>\n                        <div class=\"col-5 pl-0 text-right\">\n                            <span class=\"currency\">\n                                <span id=\"requested-amount-withdrawal\" class=\"text-right\" style=\"color: #636363;\">\n                                    ".concat(formatMoney(removeFormatNumbers(currentBalance)), "\n                                </span>\n                            </span>\n                        </div>\n                    </div>\n                    <div class=\"row mx-0 my-20\" style=\"background-color:#FFF2F2;;\">\n                        <div class='col-7 d-flex align-items-center py-20'><p> D\xC9BITOS PENDENTES </p></div>\n                        <div class=\"col-5 pl-0 d-flex align-items-center justify-content-end\">\n                            <span class=\"currency\">\n                                <span id=\"value-withdrawal-debt-pending\" class=\"text-right\" style=\"color: #FF003D;\">\n                                    - ").concat(formatMoney(removeFormatNumbers(debitValue)), "\n                                </span>\n                            </span>\n                        </div>\n                    </div>\n                    <div class=\"row mx-0\">\n                        <div class='col-7'><p> FINAL </p></div>\n                        <div class=\"col-5 pl-0 text-right\">\n                            <span class=\"currency\">\n                                <span id=\"value-withdrawal-received\" class=\"text-right\" style=\"color: #636363;\">\n                                    ").concat(formatMoney(result), "\n                                </span>\n                            </span>\n                        </div>\n                    </div>\n                </div>\n            ")).show();
  $footer.html("\n            <hr>\n            <div class=\"row justify-content-center w-p100\">\n                <button class=\"btn col-auto s-btn-border\" data-dismiss=\"modal\" aria-label=\"Close\"\n                style=\"background-color: #2E85EC; color: #FFF\">\n                    Ok, entendi!\n                </button>\n            </div>\n        ");
}

function modalDebitWithdrawal(currentBalance, debitValue, withdrawal) {
  var $modal = $("#debit-pending-informations");
  var $footer = $("#modal-withdrawal-custom-footer");
  var $modalCustomBody = $("#modal-body-withdrawal-custom");
  var $modalCustomTitle = $("#modal-title-withdrawal-custom");
  $modalCustomBody.html("").addClass("d-none");
  $modalCustomTitle.text("Não é possivel realizar este saque").parent().addClass("debit-pending");
  var $amountWithdrawal = $("#requested-amount-withdrawal");
  $amountWithdrawal.text(formatMoney(withdrawal));
  var result = removeFormatNumbers(withdrawal) - removeFormatNumbers(debitValue);
  $modal.removeClass("d-none").html("\n                <h3 class=\"text-center mt-10\" id=\"text-title-debit-pending\">\n                    Voc\xEA tem d\xE9bitos pendentes superiores ao <br> valor do seu saldo dispon\xEDvel.\n                </h3>\n                <p id=\"text-description-debit-pending\">\n                    Voc\xEA s\xF3 poder\xE1 solicitar um saque quando seu valor solicitado for maior <br>\n                    que o valor dos d\xE9bitos pendentes.\n                </p>\n\n                <div id=\"debit-items\">\n                    <div class=\"row mx-0\">\n                        <div class='col-7'><p> VALOR SOLICITADO </p></div>\n                        <div class=\"col-5 pl-0 text-right\">\n                            <span class=\"currency\">\n                                <span id=\"requested-amount-withdrawal\" class=\"text-right\" style=\"color: #636363;\">\n                                    ".concat(formatMoney(removeFormatNumbers(currentBalance)), "\n                                </span>\n                            </span>\n                        </div>\n                    </div>\n                    <div class=\"row mx-0 my-20\" style=\"background-color:#FFF2F2;;\">\n                        <div class='col-7 d-flex align-items-center py-20'><p> D\xC9BITOS PENDENTES </p></div>\n                        <div class=\"col-5 pl-0 d-flex align-items-center justify-content-end\">\n                            <span class=\"currency\">\n                                <span id=\"value-withdrawal-debt-pending\" class=\"text-right\" style=\"color: #FF003D;\">\n                                    - ").concat(formatMoney(removeFormatNumbers(debitValue)), "\n                                </span>\n                            </span>\n                        </div>\n                    </div>\n                    <div class=\"row mx-0\">\n                        <div class='col-7'><p> FINAL </p></div>\n                        <div class=\"col-5 pl-0 text-right\">\n                            <span class=\"currency\">\n                                <span id=\"value-withdrawal-received\" class=\"text-right\" style=\"color: #636363;\">\n                                    ").concat(formatMoney(result), "\n                                </span>\n                            </span>\n                        </div>\n                    </div>\n                </div>\n            ")).show();
  $footer.html("\n            <hr>\n            <div class=\"row justify-content-center w-p100\">\n                <button class=\"btn col-auto s-btn-border\" data-dismiss=\"modal\" aria-label=\"Close\"\n                style=\"background-color: #2E85EC; color: #FFF\">\n                    Ok, entendi!\n                </button>\n            </div>\n        ");
}

function modalEmptyWithdrawal(withdrawal) {
  var $modal = $("#debit-pending-informations");
  var $footer = $("#modal-withdrawal-custom-footer");
  var $modalCustomBody = $("#modal-body-withdrawal-custom");
  var $modalCustomTitle = $("#modal-title-withdrawal-custom");
  $modalCustomBody.html("").addClass("d-none");
  $modalCustomTitle.text("Não é possivel realizar este saque").parent().addClass("debit-pending");
  var $amountWithdrawal = $("#requested-amount-withdrawal");
  $amountWithdrawal.text(formatMoney(withdrawal));
  $modal.removeClass("d-none").html("\n                <h3 class=\"text-center mt-10\" id=\"text-title-debit-pending\">\n                    Voc\xEA n\xE3o possui nenhuma venda com o valor inferior ao saldo dispon\xEDvel para efetuar o saque.\n                </h3>\n            ").show();
  $footer.html("\n            <hr>\n            <div class=\"row justify-content-center w-p100\">\n                <button class=\"btn col-auto s-btn-border\" data-dismiss=\"modal\" aria-label=\"Close\"\n                style=\"background-color: #2E85EC; color: #FFF\">\n                    Ok, entendi!\n                </button>\n            </div>\n        ");
}

function modalCustomWithdrawal(singleValue, dataWithdrawal, debitValue) {
  var $options = optionsValuesWithdrawal(singleValue, dataWithdrawal);
  var $modal = $("#modal-body-withdrawal-custom");
  var $footer = $("#modal-withdrawal-custom-footer");
  var $modalDebitPending = $("#debit-pending-informations");
  var $modalCustomTitle = $("#modal-title-withdrawal-custom");
  $modalDebitPending.html("").addClass("d-none");
  $modalCustomTitle.text("Confirmar saque").parent().removeClass("debit-pending");
  $modal.removeClass("d-none").html("\n                <h3 id=\"text-title-withdrawal-custom\" class=\"text-center mb-1\">\n                    ".concat(singleValue ? "Valor a ser sacado" : "Valores disponíveis:", "\n                </h3>\n                <p id=\"text-description-withdrawal-custom\" class=\"text-center ").concat(singleValue ? "" : "mb-30", "\">\n                    ").concat(singleValue ? "" : "Selecione o valor que mais se encaixa a sua solicitação", "\n                </p>\n                <div class=\"text-center\">\n                    <div id=\"more-than-on-values-show\">\n                        ").concat($options, "\n                    </div>\n                </div>\n            "));

  if (!isEmptyValue(debitValue)) {
    var $newValueSelected = $modal.find(".value-select");
    var $value = $newValueSelected.text().trim();
    var result = $newValueSelected.data("value") - removeFormatNumbers(debitValue);
    $modalDebitPending.removeClass("d-none").html("\n                    <h3 class=\"text-center mt-10 mb-0\" id=\"text-title-debit-pending\"> D\xE9bitos pendentes </h3>\n                    <p class=\"mt-5\" id=\"text-description-debit-pending\">\n                        Voc\xEA tem alguns valores em aberto\n                    </p>\n\n                    <div id=\"debit-items\">\n                        <div class=\"row mx-0\">\n                            <div class='col-7'><p> VALOR SOLICITADO </p></div>\n                            <div class=\"col-5 pl-0 text-right\">\n                                <span class=\"currency\">\n                                    <span id=\"requested-amount-withdrawal\" class=\"text-right\" style=\"color: #636363;\">\n                                        ".concat($value, "\n                                    </span>\n                                </span>\n                            </div>\n                        </div>\n                        <div class=\"row mx-0 my-20\" style=\"background-color:#FFF2F2;\">\n                            <div class='col-7 d-flex align-items-center py-20'><p> D\xC9BITOS PENDENTES </p></div>\n                            <div class=\"col-5 pl-0 d-flex align-items-center justify-content-end\">\n                                <span class=\"currency\">\n                                    <span id=\"value-withdrawal-debt-pending\" class=\"text-right\" style=\"color: #FF003D;\">\n                                        - ").concat(formatMoney(removeFormatNumbers(debitValue)), "\n                                    </span>\n                                </span>\n                            </div>\n                        </div>\n                        <div class=\"row mx-0\">\n                            <div class='col-7'><p>VALOR A RECEBER</p></div>\n                            <div class=\"col-5 pl-0 text-right\">\n                                <span class=\"currency\">\n                                    <span id=\"value-withdrawal-received\" class=\"text-right\" style=\"color: #1BE4A8;\">\n                                        ").concat(formatMoney(result), "\n                                    </span>\n                                </span>\n                            </div>\n                        </div>\n                    </div>\n                ")).show();
  }

  $footer.html("\n                <div class=\"row justify-content-center w-p100\">\n                    <button id=\"bt-cancel-withdrawal\" data-dismiss=\"modal\" aria-label=\"Close\"\n                    class=\"btn col-auto s-btn-border mr-10\"\n                    style=\"color: #959595;\">\n                        Cancelar\n                    </button>\n\n                    <button id=\"bt-confirm-withdrawal-modal-custom\"\n                    class=\"btn btn-success col-auto btn-confirmation s-btn-border m-0\"\n                    style=\"background-color: #1BE4A8;\">\n                        <strong>Confirmar</strong>\n                    </button>\n                </div>\n            ");
  var $event = $("#bigger-value, #lower-value");
  $event.off("click");
  $event.on("click", function () {
    var $value = $(this);
    var $amountWithdrawal = $("#requested-amount-withdrawal");
    $event.removeClass("green value-select");
    $value.addClass("green value-select");
    $amountWithdrawal.text($value.text().trim());

    if (debitValue != undefined) {
      var $valueWithdrawal = $("#value-withdrawal-received");

      var _result = $value.data("value") - removeFormatNumbers(debitValue);

      $valueWithdrawal.text(formatMoney(_result));
    }
  });
  $(document).on("click", "#bt-confirm-withdrawal-modal-custom", function (e) {
    var click = $(this);

    if (click.data("clicked")) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }

    click.data("clicked", true);
    window.setTimeout(function () {
      click.removeData("clicked");
    }, 2000);
    loadOnModal("#modal-body-withdrawal-custom");
    $("#bt-confirm-withdrawal-modal-custom").attr("disabled", "disabled");
    $.ajax({
      url: "/api/withdrawals",
      type: "POST",
      data: {
        company_id: $('.company-navbar').val(),
        withdrawal_value: $(".value-select").data("value"),
        gateway_id: window.gatewayCode
      },
      dataType: "json",
      headers: {
        Authorization: $('meta[name="access-token"]').attr("content"),
        Accept: "application/json"
      },
      error: function error(response) {
        loadingOnScreenRemove();
        errorAjaxResponse(response);
      },
      success: function success(response) {
        loadingOnScreenRemove();
        loadOnAny(".price", true);
        manipulateModalSuccessWithdrawal();
        $(".btn-return").off("click");
        $(".btn-return").on("click", function () {
          $("#custom-input-addon").val("");
          $(".modal-body #modal-body-withdrawal-custom").modal("hide");
        });
        updateBalances();
      },
      complete: function complete(response) {
        $("#bt-confirm-withdrawal-modal-custom").removeAttr("disabled");
      }
    });
  });
}

function manipulateModalWithdrawal(dataWithdrawal) {
  dataWithdrawal = {
    lower_value: dataWithdrawal.lower_value,
    bigger_value: dataWithdrawal.bigger_value
  };
  var currentBalance = $(".available-balance").first().text().replace(/,/g, "").replace(/\./g, "");
  var withdrawal = $("#custom-input-addon").first().val().replace(/,/g, "").replace(/\./g, "");
  var debitValue = onlyNumbers($(".debt-balance").first().text().replace(/,/g, "").replace(/\./g, ""));
  var singleValue = modalValueIsSingleValue(dataWithdrawal, currentBalance, withdrawal, debitValue);
  var withdrawRequestValid = false;
  var totalBalanceNegative = false;

  if (debitValue != undefined) {
    var biggerValueIsZero = dataWithdrawal.bigger_value - removeFormatNumbers(debitValue);
    var lowerValueIsZero = dataWithdrawal.lower_value - removeFormatNumbers(debitValue);
    var debitVerify = removeFormatNumbers(currentBalance) - removeFormatNumbers(debitValue);

    if (debitVerify < 1 && debitValue > 1) {
      totalBalanceNegative = true;
      modalDebitPending(currentBalance, debitValue);
    } else if (biggerValueIsZero < 1 && lowerValueIsZero < 1 && debitValue > 1) {
      withdrawRequestValid = true;
      modalDebitWithdrawal(dataWithdrawal.bigger_value, debitValue, withdrawal);
    } else if (biggerValueIsZero < 1 && lowerValueIsZero < 1) {
      withdrawRequestValid = true;
      modalEmptyWithdrawal(withdrawal);
    }
  }

  if (withdrawRequestValid === false && totalBalanceNegative === false) {
    modalCustomWithdrawal(singleValue, dataWithdrawal, debitValue);
  }

  $("#modal-withdrawal-custom").modal("show");
}

function manipulateModalSuccessWithdrawal() {
  $("#debit-pending-informations").html("");
  $("#modal-title-withdrawal-custom").text("Sucesso!");
  $(".modal-body #modal-body-withdrawal-custom").html("\n        <svg style=\"max-width: 70px; max-height: 70px;\" class=\"checkmark\"\n        xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\n            <circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\n            <path class=\"checkmark__check\" fill=\"none\" d=\"M14.1 27.2l7.1 7.2 16.7-16.8\"/>\n        </svg>\n        <h3 id=\"text-title-withdrawal-custom\" class=\"text-center\">\n            <strong>Sua solicita\xE7\xE3o foi para avalia\xE7\xE3o!</strong>\n        </h3>");
  $("#modal-withdrawal-custom-footer").html("\n        <div style=\"width:100%;text-align:center;padding-top:3%\">\n            <span class=\"btn btn-success btn-return\" data-dismiss=\"modal\">\n                Retornar\n            </span>\n        </div>");
}

function modalValueIsSingleValue(dataWithdrawal, currentBalance, withdrawal, debitValue) {
  var valueLowerIsNegative = 2;

  if (debitValue != undefined) {
    valueLowerIsNegative = dataWithdrawal.lower_value - removeFormatNumbers(debitValue);
  }

  return valueLowerIsNegative < 1 || dataWithdrawal.lower_value == 0 || dataWithdrawal.bigger_value == withdrawal || dataWithdrawal.lower_value == withdrawal || currentBalance == dataWithdrawal.bigger_value;
}

function optionsValuesWithdrawal(singleValue, dataWithdrawal) {
  var biggerValue = formatMoney(dataWithdrawal.bigger_value);
  var lowerValue = formatMoney(dataWithdrawal.lower_value);

  if (singleValue) {
    return "\n                <div id=\"just-value-show\" class=\"text-center mt-25\">\n                    <div id=\"single-value\" class=\"value-select\" data-value=\"".concat(dataWithdrawal.bigger_value, "\">\n                        ").concat(biggerValue, "\n                    </div>\n                </div>\n            ");
  }

  return "\n            <div>\n                <div class=\"row justify-content-center w-p100 m-0\">\n                    <div class=\"col-auto btn btn-primary s-btn s-btn-border mr-10\" id=\"lower-value\" data-value=\"".concat(dataWithdrawal.lower_value, "\">\n                        ").concat(lowerValue, "\n                    </div>\n\n                    <div class=\"col-auto btn btn-primary s-btn s-btn-border green value-select\" id=\"bigger-value\" data-value=\"").concat(dataWithdrawal.bigger_value, "\">\n                        ").concat(biggerValue, "\n                    </div>\n                </div>\n            </div>\n        ");
}

function removeFormatNumbers(number) {
  number += "";
  return number.replace(/,/g, "").replace(/\./g, "");
}

function formatMoney(value) {
  return (value / 100).toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  }).replace(/\s+/g, "").replace("-", "- ");
}
