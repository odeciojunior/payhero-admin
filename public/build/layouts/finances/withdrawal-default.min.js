$('#bt-withdrawal, #bt-withdrawal_m').on('click', function () {
  var availableBalanceText = $('.available-balance').html().replace(',', '').replace('.', '');
  var toTransferText = $('#custom-input-addon').val().replace(',', '').replace('.', '');
  var availableBalance = parseInt(availableBalanceText);
  var toTransfer = parseFloat(toTransferText);

  if (!verifyWithdrawalIsValid(toTransfer, availableBalance)) {
    return;
  }

  $("#bt-withdrawal, #bt-withdrawal_m").attr("disabled", "disabled");
  $.ajax({
    url: "/api/withdrawals/getaccountinformation",
    type: "POST",
    dataType: "json",
    data: {
      company_id: $('#company-navbar').val(),
      gateway_id: window.gatewayCode,
      withdrawal_value: $("#custom-input-addon").val()
    },
    headers: {
      'Authorization': $('meta[name="access-token"]').attr('content'),
      'Accept': 'application/json'
    },
    error: function error(response) {
      errorAjaxResponse(response);
    },
    success: function success(response) {
      if (response.data.user_pending === true || response.data.company_pending === true) {
        modalDocsPending(response.data);
      } else {
        dataWithdrawal = {
          bigger_value: toTransfer,
          lower_value: 0
        };
        modalCustomWithdrawal(true, dataWithdrawal);
      }

      $("#modal-withdrawal-custom").modal("show");
    },
    complete: function complete() {
      $("#bt-withdrawal, #bt-withdrawal_m").removeAttr("disabled");
    }
  });

  function modalDocsPending(data) {
    var $modal = $("#debit-pending-informations");
    var $footer = $("#modal-withdrawal-custom-footer");
    var $modalCustomBody = $("#modal-body-withdrawal-custom");
    var $modalCustomTitle = $("#modal-title-withdrawal-custom");
    var description = "Parece que ainda existe pendencias com seus documentos <br>\n         Seria bom conferir se todos os documentos j\xE1 foram cadastrados";

    if (data.company_pending) {
      description = "Parece que ainda existe pendencias com os documentos de sua empresa <br>\n             Seria bom conferir se todos os documentos j\xE1 foram cadastrados.";
    }

    $modalCustomBody.html('').addClass('d-none');
    $modalCustomTitle.text("Você tem documentos pendentes").parent().removeClass('debit-pending');
    $modal.removeClass('d-none').html("\n                <div class=\"text-center my-10\">\n                    <svg width=\"151\" height=\"150\" viewBox=\"0 0 151 150\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                        <path d=\"M75.5 150C116.921 150 150.5 116.421 150.5 75C150.5 33.5786 116.921 0 75.5 0C34.0786 0 0.5 33.5786 0.5 75C0.5 116.421 34.0786 150 75.5 150Z\" fill=\"url(#paint0_linear_729_70)\"/>\n                        <path d=\"M120.5 150H30.5V53C34.742 52.9952 38.8089 51.308 41.8084 48.3085C44.808 45.3089 46.4952 41.242 46.5 37H104.5C104.496 39.1014 104.908 41.1828 105.713 43.1238C106.518 45.0648 107.7 46.8268 109.191 48.308C110.672 49.7991 112.434 50.9816 114.375 51.787C116.317 52.5924 118.398 53.0047 120.5 53V150Z\" fill=\"white\"/>\n                        <path d=\"M75.5 102C88.7548 102 99.5 91.2548 99.5 78C99.5 64.7452 88.7548 54 75.5 54C62.2452 54 51.5 64.7452 51.5 78C51.5 91.2548 62.2452 102 75.5 102Z\" fill=\"#4285F4\"/>\n                        <path d=\"M83.9853 89.3139L75.5 80.8286L67.0147 89.3139L64.1863 86.4854L72.6716 78.0002L64.1863 69.5149L67.0147 66.6865L75.5 75.1717L83.9853 66.6865L86.8137 69.5149L78.3284 78.0002L86.8137 86.4854L83.9853 89.3139Z\" fill=\"white\"/>\n                        <path d=\"M88.5 108H62.5C60.8431 108 59.5 109.343 59.5 111C59.5 112.657 60.8431 114 62.5 114H88.5C90.1569 114 91.5 112.657 91.5 111C91.5 109.343 90.1569 108 88.5 108Z\" fill=\"#DFEAFB\"/>\n                        <path d=\"M97.5 120H53.5C51.8431 120 50.5 121.343 50.5 123C50.5 124.657 51.8431 126 53.5 126H97.5C99.1569 126 100.5 124.657 100.5 123C100.5 121.343 99.1569 120 97.5 120Z\" fill=\"#DFEAFB\"/>\n                        <defs>\n                        <linearGradient id=\"paint0_linear_729_70\" x1=\"75.5\" y1=\"0\" x2=\"75.5\" y2=\"150\" gradientUnits=\"userSpaceOnUse\">\n                        <stop stop-color=\"#E3ECFA\"/>\n                        <stop offset=\"1\" stop-color=\"#DAE7FF\"/>\n                        </linearGradient>\n                        </defs>\n                    </svg>\n                </div>\n                <h3 class=\"text-center\" id=\"text-title-withdrawal-custom\">\n                    N\xE3o \xE9 poss\xEDvel realizar saque sem a confirma\xE7\xE3o dos documentos.\n                </h3>\n                <p id=\"text-description-withdrawal-custom\">\n                    ".concat(description, "\n                </p>\n            ")).show();
    $footer.html("\n            <div class=\"row justify-content-center w-p100\">\n                <a class=\"pointer\" href=\"".concat(data.route, "\">\n                    <button class=\"btn col-auto s-btn-border mr-10\" style=\"background-color: #2E85EC; color: #FFF\">\n                        Enviar documentos\n                    </button>\n                </a>\n\n                <button class=\"btn btn-outline-default col-auto s-btn-border m-0\"\n                style=\"border-color: #484848;\" data-dismiss=\"modal\" aria-label=\"Close\">\n                    <strong style=\"color: #484848\">Deixar para depois</strong>\n                </button>\n            </div>\n        "));
  }

  function modalCustomWithdrawal(singleValue, dataWithdrawal) {
    var debitValue = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;
    var $options = optionsValuesWithdrawal(singleValue, dataWithdrawal);
    var $modal = $("#modal-body-withdrawal-custom");
    var $footer = $("#modal-withdrawal-custom-footer");
    var $modalDebitPending = $('#debit-pending-informations');
    var $modalCustomTitle = $("#modal-title-withdrawal-custom");
    $modalDebitPending.html('').addClass('d-none');
    $modalCustomTitle.text("Confirmar saque").parent().removeClass('debit-pending');
    $modal.removeClass('d-none').html("\n                <h3 id=\"text-title-withdrawal-custom\" class=\"text-center mb-1\">\n                    ".concat(singleValue ? "Valor a ser sacado" : "Valores disponíveis:", "\n                </h3>\n                <p id=\"text-description-withdrawal-custom\" class=\"text-center ").concat(singleValue ? "" : "mb-30", "\">\n                    ").concat(singleValue ? "" : "Selecione o valor que mais se encaixa a sua solicitação", "\n                </p>\n                <div class=\"text-center\">\n                    <div id=\"more-than-on-values-show\">\n                        ").concat($options, "\n                    </div>\n                </div>\n            "));

    if (!isEmptyValue(debitValue)) {
      var $newValueSelected = $modal.find(".value-select");
      var $value = $newValueSelected.text().trim();
      var result = $newValueSelected.data("value") - removeFormatNumbers(debitValue);
      $modalDebitPending.removeClass('d-none').html("\n                    <h3 class=\"text-center mt-10 mb-0\" id=\"text-title-debit-pending\"> D\xE9bitos pendentes </h3>\n                    <p class=\"mt-5\" id=\"text-description-debit-pending\">\n                        Voc\xEA tem alguns valores em aberto\n                    </p>\n\n                    <div id=\"debit-items\">\n                        <div class=\"row mx-0\">\n                            <div class='col-7'><p> VALOR SOLICITADO </p></div>\n                            <div class=\"col-5 pl-0 text-right\">\n                                <span class=\"currency\">\n                                    <span id=\"requested-amount-withdrawal\" class=\"text-right\" style=\"color: #636363;\">\n                                        ".concat($value, "\n                                    </span>\n                                </span>\n                            </div>\n                        </div>\n                        <div class=\"row mx-0 my-20\" style=\"background-color:#FFF2F2;\">\n                            <div class='col-7 d-flex align-items-center py-20'><p> D\xC9BITOS PENDENTES </p></div>\n                            <div class=\"col-5 pl-0 d-flex align-items-center justify-content-end\">\n                                <span class=\"currency\">\n                                    <span id=\"value-withdrawal-debt-pending\" class=\"text-right\" style=\"color: #FF003D;\">\n                                        - ").concat(formatMoney(removeFormatNumbers(debitValue)), "\n                                    </span>\n                                </span>\n                            </div>\n                        </div>\n                        <div class=\"row mx-0\">\n                            <div class='col-7'><p>VALOR A RECEBER</p></div>\n                            <div class=\"col-5 pl-0 text-right\">\n                                <span class=\"currency\">\n                                    <span id=\"value-withdrawal-received\" class=\"text-right\" style=\"color: #1BE4A8;\">\n                                        ").concat(formatMoney(result), "\n                                    </span>\n                                </span>\n                            </div>\n                        </div>\n                    </div>\n                ")).show();
    }

    $footer.html("\n                <div class=\"row justify-content-center w-p100\">\n                    <button id=\"bt-cancel-withdrawal\" data-dismiss=\"modal\" aria-label=\"Close\"\n                    class=\"btn col-auto s-btn-border mr-10\"\n                    style=\"color: #959595;\">\n                        Cancelar\n                    </button>\n\n                    <button id=\"bt-confirm-withdrawal-modal-custom\"\n                    class=\"btn btn-success col-auto btn-confirmation s-btn-border m-0\"\n                    style=\"background-color: #1BE4A8;\">\n                        <strong>Confirmar</strong>\n                    </button>\n                </div>\n            ");
    var $event = $("#bigger-value, #lower-value, #single-value");
    $event.off("click");
    $event.on("click", function () {
      var $value = $(this);
      var $amountWithdrawal = $("#requested-amount-withdrawal");
      $event.removeClass("green value-select");
      $value.addClass("green value-select");
      $amountWithdrawal.text($value.text().trim());

      if (debitValue != undefined) {
        var $valueWithdrawal = $("#value-withdrawal-received");

        var _result = $value.data("value") - removeFormatNumbers(debitValue);

        $valueWithdrawal.text(formatMoney(_result));
      }
    });
    $(document).on('click', '#bt-confirm-withdrawal-modal-custom', function (e) {
      var click = $(this);

      if (click.data('clicked')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }

      click.data('clicked', true);
      window.setTimeout(function () {
        click.removeData('clicked');
      }, 2000);
      loadOnModal("#modal-body-withdrawal-custom");
      $("#bt-confirm-withdrawal-modal-custom").attr("disabled", "disabled");
      $.ajax({
        url: "/api/withdrawals",
        type: "POST",
        data: {
          company_id: $('#company-navbar').val(),
          withdrawal_value: $(".value-select").data("value"),
          gateway_id: window.gatewayCode
        },
        dataType: "json",
        headers: {
          Authorization: $('meta[name="access-token"]').attr("content"),
          Accept: "application/json"
        },
        error: function error(response) {
          loadingOnScreenRemove();
          errorAjaxResponse(response);
        },
        success: function success(response) {
          loadingOnScreenRemove();
          loadOnAny(".price", true);
          manipulateModalSuccessWithdrawal();
          $(".btn-return").off("click");
          $(".btn-return").on("click", function () {
            $("#custom-input-addon").val("");
            $(".modal-body #modal-body-withdrawal-custom").modal("hide");
          });
          updateBalances();
        },
        complete: function complete(response) {
          $("#bt-confirm-withdrawal-modal-custom").removeAttr("disabled");
        }
      });
    });
  }

  function verifyWithdrawalIsValid(toTransfer, availableBalance) {
    if (toTransfer < 1) {
      alertCustom("error", "Valor do saque inválido!");
      $("#custom-input-addon").val("");
      $(".withdrawal-value").maskMoney({
        thousands: ".",
        decimal: ",",
        allowZero: true
      });
      return false;
    }

    if (toTransfer > availableBalance) {
      alertCustom("error", "O valor requerido ultrapassa o limite disponivel");
      $("#custom-input-addon").val("");
      $(".withdrawal-value").maskMoney({
        thousands: ".",
        decimal: ",",
        allowZero: true
      });
      return false;
    }

    if ($("#custom-input-addon").val() == "") {
      alertCustom("error", "Valor do saque inválido!");
      return false;
    }

    if (toTransfer < 5000) {
      alertCustom('error', 'Valor mínimo de saque  R$ 50,00');
      return;
    }

    return true;
  }

  function optionsValuesWithdrawal(singleValue, dataWithdrawal) {
    var biggerValue = formatMoney(dataWithdrawal.bigger_value);
    var lowerValue = formatMoney(dataWithdrawal.lower_value);

    if (singleValue) {
      return "\n                <div id=\"just-value-show\" class=\"text-center\">\n                    <div id=\"single-value\" class=\"value-select\" data-value=\"".concat(dataWithdrawal.bigger_value, "\">\n                        ").concat(biggerValue, "\n                    </div>\n                </div>\n            ");
    }

    return "\n            <div>\n                <div class=\"row justify-content-center w-p100 m-0\">\n                    <div class=\"col-auto btn btn-primary s-btn s-btn-border mr-10\" id=\"lower-value\" data-value=\"".concat(dataWithdrawal.lower_value, "\">\n                        ").concat(lowerValue, "\n                    </div>\n\n                    <div class=\"col-auto btn btn-primary s-btn s-btn-border green value-select\" id=\"bigger-value\" data-value=\"").concat(dataWithdrawal.bigger_value, "\">\n                        ").concat(biggerValue, "\n                    </div>\n                </div>\n            </div>\n        ");
  }

  function manipulateModalSuccessWithdrawal() {
    $("#debit-pending-informations").html("");
    $("#modal-title-withdrawal-custom").text("Sucesso!");
    $(".modal-body #modal-body-withdrawal-custom").html("\n        <svg style=\"max-width: 70px; max-height: 70px;\" class=\"checkmark\"\n        xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\n            <circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\n            <path class=\"checkmark__check\" fill=\"none\" d=\"M14.1 27.2l7.1 7.2 16.7-16.8\"/>\n        </svg>\n        <h3 id=\"text-title-withdrawal-custom\" class=\"text-center\">\n            <strong>Sua solicita\xE7\xE3o foi para avalia\xE7\xE3o!</strong>\n        </h3>");
    $("#modal-withdrawal-custom-footer").html("\n        <div style=\"width:100%;text-align:center;padding-top:3%\">\n            <span class=\"btn btn-success btn-return\" data-dismiss=\"modal\">\n                Retornar\n            </span>\n        </div>");
  }

  function formatMoney(value) {
    return (value / 100).toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    }).replace(/\s+/g, '').replace('-', '- ');
  }
});
