$(document).ready(function () {
  var integrationTypeEnum = {
    external: "Integração externa",
    checkout_api: "Checkout API"
  };
  var integrationTypeEnumBadge = {
    admin: "default",
    personal: "default",
    external: "success",
    checkout_api: "primary"
  };
  var status = {
    active: "Ativo",
    inactive: "Inativo"
  };
  var statusBadge = {
    active: "success",
    inactive: "danger" // 3: 'warning',

  };
  refreshIntegrations();
  createIntegration();
  getCompanies();

  function refreshIntegrations() {
    var page = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1;
    loadingOnScreen();
    $.ajax({
      method: "GET",
      url: "/api/integrations?resume=true&page=" + page,
      dataType: "json",
      headers: {
        Authorization: $('meta[name="access-token"]').attr("content"),
        Accept: "application/json"
      },
      error: function error(response) {
        loadingOnScreenRemove();
        errorAjaxResponse(response);
      },
      success: function success(response) {
        if (isEmpty(response.data)) {
          $(".page-header").find(".store-integrate").css("display", "none");
          $("#content-error").find(".store-integrate").css("display", "block");
          $("#content-error").css("display", "block");
          $("#content-script").css("display", "none");
          $("#card-table-integrate").css("display", "none");
          $("#card-integration-data").css("display", "none");
        } else {
          $(".page-header").find(".store-integrate").css("display", "block");
          $("#content-error").find(".store-integrate").css("display", "none");
          $("#content-error").hide();
          updateIntegrationTableData(response);
          pagination(response, "integrates");
        }

        getIntegration();
        refreshToken();
        deleteIntegration();
        loadingOnScreenRemove();
      }
    });
  } // Atualiza tabela de dados com a lista de integrações


  function updateIntegrationTableData(response) {
    $("#content-script").css("display", "block");
    $("#card-table-integrate").css("display", "block");
    $("#card-integration-data").css("display", "block"); // $("#text-info").css('display', 'block');

    $("#card-table-integrate").css("display", "block");
    $("#table-body-integrates").html("");

    if (response.data.length > 0 && response.data.findIndex(function (e) {
      return e.integration_type == "checkout_api";
    }) != -1) {
      $("#content-script").show();
      $("#input-url-antifraud").val(response.data[0].antifraud_url);
    } else {
      $("#content-script").hide();
      $("#input-url-antifraud").val("");
    }

    $.each(response.data, function (index, value) {
      var disabled = "active" !== value.status ? " disabled" : "";
      dados = "";
      dados += "<tr>";
      dados += '<td class="" style="vertical-align: middle;">';
      dados += '<p class="description mb-0 mr-1">' + value.description + "</p>";
      dados += '<small class="text-muted">Criada em ' + value.register_date + "</small>";
      dados += "</td>";
      dados += '<td class="text-center">';
      dados += '<span class="badge badge-' + integrationTypeEnumBadge[value.integration_type] + ' text-center">' + integrationTypeEnum[value.integration_type] + "</span>";
      dados += "</td>";
      dados += '<td style="vertical-align: middle;">';
      dados += '<div class="input-group input-group-lg">';
      dados += '<input type="text" class="form-control font-sm brr inptToken" id="inputToken-' + value.id_code + '" value="' + value.access_token + '" disabled="disabled" style="background: #F1F1F1;">';
      dados += '<div class="input-group-append">';
      dados += '<button class="btn btn-primary bg-white btnCopiarLink" data-code="' + value.id_code + '" type="button" data-placement="top" data-toggle="tooltip" title="Copiar token" style="width: 48px; height: 48px;">';
      dados += '<img src="/build/global/img/icon-copy-b.svg">';
      dados += "</button>";
      dados += "</div>";
      dados += "</div>";
      dados += "</td>";
      dados += '<td class="text-center">';
      dados += '<button class="btn pointer edit-integration" style="background-color:transparent;" integration="' + value.id_code + '"' + disabled + ' title="Editar integração"><span class="o-edit-1"></span></button>'; //dados += '<button class="btn pointer refresh-integration" style="background-color:transparent;" integration="' + value.id_code + '"' + disabled + ' title="Regerar token"><span class="o-reload-1"></span></button>';

      dados += '<button class="btn pointer delete-integration" style="background-color:transparent;" integration="' + value.id_code + '"' + disabled + ' title="Deletar token"><span class="o-bin-1"></span></button>';
      dados += "</td>";
      dados += "</tr>";
      $("#table-body-integrates").append(dados);
    });
    $("#integrations_stored").html("" + response.resume.total + "");
    $("#integrations_active").html("" + response.resume.active + "");
    $("#posts_received").html("" + response.resume.received + "");
    $("#posts_sent").html("" + response.resume.sent + "");
  } // Obtem os dados da integração


  function getIntegration() {
    $(".edit-integration").unbind("click");
    $(".edit-integration").on("click", function () {
      $("#modal-edit-integration").find('input[name="description"]').val("");
      $("#modal-edit-integration").find('input[name="postback"]').val("");
      var integration_id = $(this).attr("integration");
      $("#modal-edit-integration").modal("show");
      $.ajax({
        method: "GET",
        url: "/api/integrations/" + integration_id,
        dataType: "json",
        headers: {
          Authorization: $('meta[name="access-token"]').attr("content"),
          Accept: "application/json"
        },
        error: function error(response) {
          errorAjaxResponse(response);
        },
        success: function success(response) {
          if (!isEmpty(response)) {
            if (response.token_type_enum == 4) {
              $("#modal-edit-integration").find('input[name="postback"]').val(response.postback);
              $("#modal-edit-integration").find(".postback-container").show();
            } else {
              $("#modal-edit-integration").find(".postback-container").hide();
              $("#modal-edit-integration").find('input[name="postback"]').val("");
            }

            $("#modal-edit-integration").find('input[name="description"]').val(response.description);
            $("#modal-edit-integration").find('input[name="token_type_enum"]').val(response.token_type_enum);
            editIntegration(integration_id);
          } else {
            alertCustom("error", "Erro ao obter dados da integração");
          }
        }
      });
    });
  } // Edita os dados da integração


  function editIntegration(integration_id) {
    $("#btn-edit-integration").unbind("click");
    $("#btn-edit-integration").on("click", function () {
      var description = $("#modal-edit-integration").find('input[name="description"]').val();
      var token_type_enum = $("#modal-edit-integration").find('input[name="token_type_enum"]').val();
      var postback = $("#modal-edit-integration").find('input[name="postback"]').val();
      loadingOnScreen();
      $.ajax({
        method: "PUT",
        url: "api/integrations/" + integration_id,
        data: {
          description: description,
          postback: postback,
          token_type_enum: token_type_enum
        },
        dataType: "json",
        headers: {
          Authorization: $('meta[name="access-token"]').attr("content"),
          Accept: "application/json"
        },
        error: function error(response) {
          loadingOnScreenRemove();
          errorAjaxResponse(response);
        },
        success: function success(response) {
          $(".close").click();
          loadingOnScreenRemove();
          refreshIntegrations();
          alertCustom("success", response.message);
        }
      });
    });
  } // Regerar token integração


  function refreshToken() {
    $(".refresh-integration").unbind("click");
    $(".refresh-integration").on("click", function () {
      var integrationId = $(this).attr("integration");
      var url = "api/integrations/" + integrationId + "/refreshtoken";
      $("#modal-refresh-integration").modal("show");
      $("#btn-refresh-integration").unbind("click");
      $("#btn-refresh-integration").on("click", function () {
        loadingOnScreen();
        $.ajax({
          method: "POST",
          url: url,
          data: {
            integrationId: integrationId
          },
          dataType: "json",
          headers: {
            Authorization: $('meta[name="access-token"]').attr("content"),
            Accept: "application/json"
          },
          error: function error(response) {
            loadingOnScreenRemove();
            errorAjaxResponse(response);
          },
          success: function success(response) {
            // console.log(response);
            loadingOnScreenRemove();
            refreshIntegrations();
            alertCustom("success", response.message);
          }
        });
      });
    });
  } // Excluir integração


  function deleteIntegration() {
    $(".delete-integration").unbind("click");
    $(".delete-integration").on("click", function () {
      var integrationId = $(this).attr("integration");
      var url = "api/integrations/" + integrationId;
      $("#modal-delete-integration").modal("show");
      $("#btn-delete-integration").unbind("click");
      $("#btn-delete-integration").on("click", function () {
        loadingOnScreen();
        $.ajax({
          method: "DELETE",
          url: url,
          data: {
            integrationId: integrationId
          },
          dataType: "json",
          headers: {
            Authorization: $('meta[name="access-token"]').attr("content"),
            Accept: "application/json"
          },
          error: function error(response) {
            loadingOnScreenRemove();
            errorAjaxResponse(response);
          },
          success: function success(response) {
            // console.log(response);
            loadingOnScreenRemove();
            refreshIntegrations();
            alertCustom("success", response.message);
          }
        });
      });
    });
  } // Adiciona nova integração


  function createIntegration() {
    $(".store-integrate").unbind();
    $(".store-integrate").on("click", function () {
      loadingOnScreenRemove();
      $("#btn-save-integration").unbind();
      $("#btn-save-integration").on("click", function () {
        var description = $("#modal-integrate").find("input[name='description']").val();
        var tokenTypeEnum = $("#select-enum-list").val();
        var postback = $("#modal-integrate").find("input[name='postback']").val();
        var companyHash = $("#companies").val();

        if (description == "") {
          alertCustom("error", "O campo Descrição é obrigatório");
        } else if (!companyHash && tokenTypeEnum == 4) {
          alertCustom("error", "O campo Empresa é obrigatório para a integração Checkout API");
        } else if (tokenTypeEnum == 4 && postback == "") {
          alertCustom("error", "O campo Postback é obrigatório para a integração Checkout API");
        } else {
          loadingOnScreen();
          storeIntegration(description, tokenTypeEnum, postback, companyHash);
        }
      });
      $("#modal-integrate").modal("show");
    });
  }

  function storeIntegration(description, tokenTypeEnum, postback, companyHash) {
    $.ajax({
      method: "POST",
      url: "/api/integrations",
      data: {
        description: description,
        token_type_enum: tokenTypeEnum,
        postback: postback,
        company_id: companyHash
      },
      dataType: "json",
      headers: {
        Authorization: $('meta[name="access-token"]').attr("content"),
        Accept: "application/json"
      },
      error: function error(response) {
        loadingOnScreenRemove();
        errorAjaxResponse(response);
      },
      success: function success(response) {
        $(".close").click();
        alertCustom("success", "Integração criada com sucesso!");
        loadingOnScreenRemove();
        refreshIntegrations();
      }
    });
  } //Botao de copiar


  $(document).on("click", ".btnCopiarLink", function () {
    var tmpInput = $("<input>");
    $("body").append(tmpInput);
    var btn_code = $(this).data("code");
    var copyText = $("#inputToken-" + btn_code).val();
    tmpInput.val(copyText).select();
    document.execCommand("copy");
    tmpInput.remove();
    alertCustom("success", "Token copiado!");
  }); //Botao de copiar URL Antifraud

  $(document).on("click", ".btnCopiarLinkAntifraud", function () {
    var tmpInput = $("<input>");
    $("body").append(tmpInput);
    var copyText = $("#input-url-antifraud").val();
    tmpInput.val(copyText).select();
    document.execCommand("copy");
    tmpInput.remove();
    alertCustom("success", "Antifraud URL copiada!");
  });

  function pagination(response, model) {
    if (response.meta.last_page == 1) {
      $("#primeira_pagina_" + model).hide();
      $("#ultima_pagina_" + model).hide();
    } else {
      $("#pagination-" + model).html("");
      var first_page = "<button id='first_page' class='btn nav-btn'>1</button>";
      $("#pagination-" + model).append(first_page);

      if (response.meta.current_page == "1") {
        $("#first_page").attr("disabled", true).addClass("nav-btn").addClass("active");
      }

      $("#first_page").on("click", function () {
        refreshIntegrations(1);
      });

      for (x = 3; x > 0; x--) {
        if (response.meta.current_page - x <= 1) {
          continue;
        }

        $("#pagination-" + model).append("<button id='page_" + (response.meta.current_page - x) + "' class='btn nav-btn'>" + (response.meta.current_page - x) + "</button>");
        $("#page_" + (response.meta.current_page - x)).on("click", function () {
          refreshIntegrations($(this).html());
        });
      }

      if (response.meta.current_page != 1 && response.meta.current_page != response.meta.last_page) {
        var current_page = "<button id='current_page' class='btn nav-btn active'>" + response.meta.current_page + "</button>";
        $("#pagination-" + model).append(current_page);
        $("#current_page").attr("disabled", true).addClass("nav-btn").addClass("active");
      }

      for (x = 1; x < 4; x++) {
        if (response.meta.current_page + x >= response.meta.last_page) {
          continue;
        }

        $("#pagination-" + model).append("<button id='page_" + (response.meta.current_page + x) + "' class='btn nav-btn'>" + (response.meta.current_page + x) + "</button>");
        $("#page_" + (response.meta.current_page + x)).on("click", function () {
          refreshIntegrations($(this).html());
        });
      }

      if (response.meta.last_page != "1") {
        var last_page = "<button id='last_page' class='btn nav-btn'>" + response.meta.last_page + "</button>";
        $("#pagination-" + model).append(last_page);

        if (response.meta.current_page == response.meta.last_page) {
          $("#last_page").attr("disabled", true).addClass("nav-btn").addClass("active");
        }

        $("#last_page").on("click", function () {
          refreshIntegrations(response.meta.last_page);
        });
      }
    }
  }

  function handleIntegrationTypeChange(e) {
    var type = e.target.value;
    var companiesContainer = $(".companies-container");
    var postbackContainer = $(".postback-container");
    var descriptionInput = $("#description");
    descriptionInput.val(""); // type = 4 is Checkout API type

    if (type == 4) {
      companiesContainer.addClass("d-flex").removeClass("d-none");
      postbackContainer.addClass("d-flex").removeClass("d-none");
    } else {
      //type = 3 is Profitfy (External Integration)
      //if(type == 3) {
      //descriptionInput.val('Profitfy');
      //}
      companiesContainer.addClass("d-none").removeClass("d-flex");
      postbackContainer.addClass("d-none").removeClass("d-flex");
    }
  }

  $("#select-enum-list").on("change", handleIntegrationTypeChange); // Obtem os campos dos filtros

  function getCompanies() {
    loadingOnScreen();
    $.ajax({
      method: "GET",
      url: "/api/core/companies?select=true",
      dataType: "json",
      headers: {
        Authorization: $('meta[name="access-token"]').attr("content"),
        Accept: "application/json"
      },
      error: function error(response) {
        errorAjaxResponse(response);
      },
      success: function success(response) {
        if (!isEmpty(response.data)) {
          $.each(response.data, function (i, company) {
            if (companyIsApproved(company)) {
              $("#companies").append($("<option>", {
                value: company.id,
                text: company.name
              }));
            }
          });
        }

        loadingOnScreenRemove();
      }
    });
  } //opens the creation modal automatically if it comes with the parameter in the url


  if (window.location.href.includes("#add_checkout_api")) {
    $('select[name="token_type_enum"]').val(4).change();
    $("#modal-integrate").modal("show");
  }
});
